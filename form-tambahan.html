<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Assessment Opsional</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap"
      rel="stylesheet"
    />

    <!---Firebase SDK-->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="firebase.js"></script>

    <style>
      body {
        font-family: "Open Sans", sans-serif;
        background-color: #fdfbec;
        color: #14532d;
        padding: 2rem;
      }
      .assessment-container {
        display: flex;
        gap: 2rem;
      }
      .sidebar {
        background-color: #fff;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        height: fit-content;
        position: sticky;
        top: 1rem;
      }
      .sidebar h5 {
        margin-bottom: 1rem;
      }
      .sidebar button {
        display: block;
        background: none;
        border: none;
        padding: 0.75rem 1rem;
        text-align: left;
        width: 100%;
        border-radius: 8px;
        color: #14532d;
        font-weight: 600;
        margin-bottom: 0.5rem;
        transition: background 0.3s;
      }
      .sidebar button:hover,
      .sidebar button.active {
        background-color: #facc15;
        color: #14532d;
      }
      .question-box {
        flex: 1;
        background: white;
        padding: 2rem;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      }
      .question-item {
        margin-bottom: 2rem;
      }
      .question-item label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
      }
      .options {
        display: flex;
        gap: 1rem;
      }
      .options button {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: 2px solid #ccc;
        background: #fdfbec;
        font-weight: bold;
        color: #14532d;
        transition: 0.2s;
      }
      .options button.active {
        background-color: #14532d;
        color: white;
        border-color: #14532d;
      }
      .btn-lanjut {
        margin-top: 2rem;
        display: inline-block;
        background-color: #14532d;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: bold;
        transition: 0.2s;
      }
      .btn-lanjut:hover {
        background-color: #0f3c21;
      }
       /* ... CSS lama kamu ... */

      .custom-radio-group {
        display: block;
        gap: 1rem;
      }

      .custom-radio-group .btn-check {
        display: none;
      }

      .custom-radio-group .custom-option {
        padding: 0.4rem 1rem;
        border: 1px solid #14532d;
        border-radius: 8px;
        font-weight: 500;
        color: #14532d;
        background-color: transparent;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 5px;
      }

      .custom-radio-group .btn-check:checked + .custom-option {
        background-color: #14532d;
        color: white;
      }
      .kategori-buttons button {
  white-space: nowrap;
}

@media (max-width: 768px) {
  .kategori-buttons {
    flex-direction: column;
    gap: 0.5rem;
  }
}
  .custom-radio-group .custom-option {
    display: block;
    width: 100%;
    text-align: left;
  }

    </style>
  </head>
  <body>
   <div class="container-fluid">
      <div class="row">
  <div class="col-12">
    <p class="mb-2 text-muted fst-italic">
  * Kategori berikut bersifat opsional. Silakan isi jika ingin menambahkan informasi tambahan.
</p>
    <div class="kategori-buttons mb-4 d-flex flex-wrap gap-2">
     <button class="btn btn-outline-dark active" data-kategori="pilar6" onclick="tampilkanSoal('pilar6', this)">Inovasi Kebijakan dan Perencanaan</button>
  <button class="btn btn-outline-dark" data-kategori="pilar7" onclick="tampilkanSoal('pilar7', this)">Tata Kelola Multipihak</button>
  <button class="btn btn-outline-dark" data-kategori="pilar8" onclick="tampilkanSoal('pilar8', this)">Ko-Kreasi Bisnis & Investasi</button>
  <button class="btn btn-outline-dark" data-kategori="pilar9" onclick="tampilkanSoal('pilar9', this)">Pengukuran Proses </button>
    </div>
    <div id="soalContainer" class="soal-container"></div>
  </div>
</div>

    <script>
      const soalData = {
        pilar6: [
          {
            pertanyaan:
              "Gugus Tugas Reforma Agraria beserta rencana kerja dan peta jalan:",
            id: "1",
            opsi: [
              { label: "Gugus Tugas Reforma Agraria belum terbentuk", skor: 0 },
              {
                label:
                  "Sudah terbentuk tapi belum ada rencana kerja dan peta jalan",
                skor: 1,
              },
              {
                label: "Sudah terbentuk beserta rencana kerja dan peta jalan",
                skor: 2,
              },
            ],
          },
          {
            pertanyaan: "Mekanisme penataan aset & akses Reforma Agraria:",
            id: "2",
            opsi: [
              {
                label:
                  "Belum ada mekanisme pelaksanaan penataan aset dan akese",
                skor: 0,
              },
              {
                label: "Mekanisme masih dalam pengembangan/belum terlaksana",
                skor: 1,
              },
              { label: "Mekanisme sudah ada dan sudah terlaksana", skor: 2 },
            ],
          },
        ],
        pilar7: [
          {
            pertanyaan: "Penyelesaian kasus SDA & proses harmonisasi PIAPS",
            id: "3",
            opsi: [
              {
                label: "Tidak ada target atau kelembagaan penanganan kasus SDA",
                skor: 0,
              },
              {
                label: "Sudah ada proses atau target tapi belum tercapai",
                skor: 1,
              },
              {
                label: "Target penyelesaian dan proses PIAPS sudah tercapai",
                skor: 2,
              },
            ],
          },
        ],
        pilar8: [
          {
            pertanyaan:
              "Realisasi penanaman komoditas strategis dengan fungsi ekologis",
            id: "4",
            opsi: [
              {
                label:
                  "Tidak ada target atau realisasi penanaman komoditas strategis",
                skor: 0,
              },
              { label: "Realisasi sebagian, masih dalam proses", skor: 1 },
              {
                label: "Realisasi sudah tercapai sesuai fungsi ekologis",
                skor: 2,
              },
            ],
          },
          {
            pertanyaan: "Persentase PDRB Hijau terhadap PDRB:",
            id: "5",
            opsi: [
              { label: "Belum ada perhitungan PDRB Hijau", skor: 0 },
              { label: "Sudah ada perhitungan, tapi belum meningkat", skor: 1 },
              {
                label:
                  "Sudah dihitung dan persentasenya meningkat dari tahun sebelumnya",
                skor: 2,
              },
            ],
          },
          {
            pertanyaan: "Produksi HHBK sesuai praktik berkelanjutan",
            id: "6",
            opsi: [
              { label: "Tidak ada target atau data produksi HHBK", skor: 0 },
              {
                label: "Ada target, masih dalam proses atau belum tercapai",
                skor: 1,
              },
              {
                label: "Produksi sesuai target dan praktek berkelanjutan",
                skor: 2,
              },
            ],
          },
        ],
        pilar9: [
          {
            pertanyaan:
              "Pemerataan sarana dan prasarana publik (khususnya desa):",
            id: "7",
            opsi: [
              {
                label: "Tidak ada target atau data sebaran prasarana",
                skor: 0,
              },
              { label: "Data atau target sebagian, belum tercapai", skor: 1 },
              {
                label: "Target tercapai, data lengkap dan dianalisis",
                skor: 2,
              },
            ],
          },
          {
            pertanyaan: "Mekanisme pemantauan kualitas air dan udara:",
            id: "8",
            opsi: [
              { label: "Belum ada mekanisme atau kelembagaan", skor: 0 },
              { label: "Mekanisme masih dalam pengembangan", skor: 1 },
              { label: "Mekanisem sudah berjalan dan terdokumentasi", skor: 2 },
            ],
          },
        ],
      };
      const jawabanUser = {};
      let kategoriAktif ="pilar6";
       function tampilkanSoal(kategori, btn = null) {
    kategoriAktif = kategori;
    document.querySelectorAll(".kategori-buttons button").forEach((b) => b.classList.remove("active"));
    if (btn) btn.classList.add("active");

    const container = document.getElementById("soalContainer");
    container.innerHTML = "";

    soalData[kategori].forEach((soal, index) => {
      const div = document.createElement("div");
      div.className = "mb-4";

      let opsiHTML = soal.opsi
        .map((opsi, i) => {
          const radioId = `opsi-${soal.id}-${i}`;
          const checked = jawabanUser[soal.id] == opsi.skor ? "checked" : "";
          return `
            <input type="radio" class="btn-check" name="soal-${soal.id}" id="${radioId}" value="${opsi.skor}" ${checked}
              onchange="jawab('${soal.id}', ${opsi.skor})">
            <label class="btn btn-outline-success custom-option" for="${radioId}">${opsi.label}</label>
          `;
        })
        .join("");

      div.innerHTML = `
        <p><strong>${index + 1}. ${soal.pertanyaan}</strong></p>
        <div class="custom-radio-group">${opsiHTML}</div>
      `;
      container.appendChild(div);
    });
// input upload dokumen
const uploadBox = document.createElement("div");
uploadBox.className = "mb-4";
uploadBox.innerHTML = `
  <label for="dokumen" class="form-label">Unggah Dokumen Pendukung (Opsional)</label>
  <input type="file" class="form-control" id="dokumen" accept=".pdf,.doc,.docx,.jpg,.png" />
  <small class="text-muted fst-italic">* Jika tersedia, mohon unggah dokumen yang mendukung jawaban Anda</small>
`;
container.appendChild(uploadBox);

    // Navigasi
    const nav = document.createElement("div");
    nav.className = "mt-4 d-flex justify-content-end gap-3";

    const btnSimpan = document.createElement("button");
    btnSimpan.className = "btn btn-outline-success rounded-pill px-4";
    btnSimpan.textContent = "Simpan";
   btnSimpan.onclick = async () => {
  const userData = JSON.parse(localStorage.getItem("userData")) || {};
  if (!userData.nohp) {
    alert("Data user tidak ditemukan.");
    return;
  }

  // Ambil semua jawaban dari jawabanUser
  const jawaban = { ...jawabanUser };

  const fileInput = document.getElementById("dokumen");
  const file = fileInput?.files[0];
  const unggahDokumen = !!file;

  try {
    const dataTambahan = {
      jawaban,
      isDraft: false,
      timestamp: new Date().toISOString(),
      unggahDokumen
    };

    await firebaseService.simpanBagianData(userData.nohp, "formTambahan", dataTambahan);
    alert("✅ Data tambahan berhasil disimpan!");
  } catch (error) {
    console.error("❌ Gagal menyimpan:", error);
    alert("Terjadi kesalahan saat menyimpan data.");
  }
};


    const btnLanjut = document.createElement("button");
    btnLanjut.className = "btn btn-warning text-white rounded-pill px-4";
    btnLanjut.textContent = "Selanjutnya";
    btnLanjut.onclick = async () => {
  simpanJawaban(); // tetap simpan ke localStorage

  const userData = JSON.parse(localStorage.getItem("userData")) || {};
  const draft = JSON.parse(localStorage.getItem(`draft-tambahan-${userData.nohp}`)) || {};

  try {
    // Simpan ke Firebase sebagai draft
    await firebaseService.simpanBagianData(userData.nohp, "formTambahan", {
      ...draft,
      isDraft: true,
    });
    console.log("✅ Draft tersimpan saat klik lanjut.");
  } catch (err) {
    console.error("❌ Gagal simpan draft saat lanjut:", err);
  }

  const keys = Object.keys(soalData);
  const index = keys.indexOf(kategoriAktif);
  const nextKategori = keys[index + 1];

  if (nextKategori) {
    const nextBtn = document.querySelector(`.kategori-buttons button[data-kategori="${nextKategori}"]`);
    tampilkanSoal(nextKategori, nextBtn);
  } else {
    window.location.href = "consent.html";
  }
};

//button untuk keluar jika user tidak ingin mengisi form
const btnKeluar = document.createElement("button");
btnKeluar.className = "btn btn-danger rounded-pill px-4";
btnKeluar.textContent = "Keluar";

btnKeluar.onclick = () => {
  const konfirmasi = confirm("Apakah Anda yakin ingin keluar tanpa mengisi form tambahan?");
  if (konfirmasi) {
    window.location.href = "index.html"; // atau ganti dengan halaman tujuanmu
  }
};

    nav.appendChild(btnSimpan);
    nav.appendChild(btnLanjut);
    nav.appendChild(btnKeluar);
    container.appendChild(nav);
  }

  function jawab(id, skor) {
    jawabanUser[id] = skor;
    console.log("Jawaban user:", jawabanUser);
  }

function simpanJawaban() {
  const userData = JSON.parse(localStorage.getItem("userData")) || {};
  if (!userData.nohp) {
    alert("Data user tidak ditemukan. Harap isi dari awal.");
    return;
  }

  // Ambil input file
  const dokumenInput = document.getElementById("dokumen");
  const unggahDokumen = dokumenInput && dokumenInput.files.length > 0;

  const hasil = {
    ...userData,
    jawaban: jawabanUser,
    timestamp: new Date().toISOString(),
    unggahDokumen: unggahDokumen, // <== ini yang disimpan
  };

  console.log("DEBUG unggah dokumen:", unggahDokumen); // Debug log

  localStorage.setItem(`draft-tambahan-${userData.nohp}`, JSON.stringify(hasil));
}


async function simpanDraftDenganAlert() {
  simpanJawaban();

  const userData = JSON.parse(localStorage.getItem("userData")) || {};
  const draft = JSON.parse(localStorage.getItem(`draft-tambahan-${userData.nohp}`)) || {};

  try {
    await firebaseService.simpanBagianData(userData.nohp, "formTambahan", {
      ...draft,
      isDraft: true,
    });
    alert("✅ Jawaban berhasil disimpan sebagai draft!");
  } catch (err) {
    console.error("❌ Gagal simpan draft:", err);
    alert("Terjadi kesalahan saat menyimpan draft.");
  }
}
const userData = JSON.parse(localStorage.getItem("userData")) || {};
const draftKeys = Object.keys(localStorage).filter(k => k.startsWith("draft-tambahan-"));


// Hapus semua draft user lain yang bukan milik user saat ini
draftKeys.forEach(key => {
  if (!key.includes(userData.nohp)) {
    localStorage.removeItem(key);
    console.log("Draft lama milik user lain dihapus:", key);
  }
});

  window.onload = () => {
  // Reset jawabanUser saat halaman di-load
  Object.keys(jawabanUser).forEach((k) => delete jawabanUser[k]);

  const userData = JSON.parse(localStorage.getItem("userData")) || {};
  const draft = localStorage.getItem(`draft-tambahan-${userData.nohp}`);

  if (draft) {
    const parsed = JSON.parse(draft);
    Object.entries(parsed.jawaban || {}).forEach(([id, skor]) => {
      jawabanUser[id] = skor;
    });
  }

  const tombolPertama = document.querySelector(".kategori-buttons button");
  if (tombolPertama) tampilkanSoal(tombolPertama.getAttribute("data-kategori"), tombolPertama);
};
    </script>
  </body>
</html>
